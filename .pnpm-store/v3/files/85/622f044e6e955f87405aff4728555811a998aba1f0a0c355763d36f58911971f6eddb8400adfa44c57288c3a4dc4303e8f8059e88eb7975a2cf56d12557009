{"version":3,"sources":["../../src/swc/compile.ts"],"sourcesContent":["import slash from \"slash\";\nimport { promises } from \"fs\";\nimport { dirname, relative } from \"path\";\nimport { transformFile, transformFileSync } from \"@swc/core\";\nimport type { Options, Output } from \"@swc/core\";\n\nconst { mkdir, stat, writeFile } = promises;\n\nfunction withSourceMap(\n  output: Output,\n  options: Options,\n  destFile: string,\n  destDir: string\n) {\n  if (!output.map || options.sourceMaps === \"inline\") {\n    return {\n      sourceCode: output.code,\n    };\n  }\n  // TODO: remove once fixed in core https://github.com/swc-project/swc/issues/1388\n  const sourceMap = JSON.parse(output.map);\n  if (options.sourceFileName) {\n    sourceMap[\"sources\"][0] = options.sourceFileName;\n  }\n  if (options.sourceRoot) {\n    sourceMap[\"sourceRoot\"] = options.sourceRoot;\n  }\n  output.map = JSON.stringify(sourceMap);\n\n  const sourceMapPath = destFile + \".map\";\n  output.code += `\\n//# sourceMappingURL=${slash(\n    relative(destDir, sourceMapPath)\n  )}`;\n\n  return {\n    sourceMap: output.map,\n    sourceMapPath,\n    sourceCode: output.code,\n  };\n}\n\nexport async function outputResult(\n  output: Output,\n  sourceFile: string,\n  destFile: string,\n  options: Options\n) {\n  const destDir = dirname(destFile);\n\n  const { sourceMap, sourceMapPath, sourceCode } = withSourceMap(\n    output,\n    options,\n    destFile,\n    destDir\n  );\n\n  await mkdir(destDir, { recursive: true });\n  const { mode } = await stat(sourceFile);\n\n  if (!sourceMapPath) {\n    await writeFile(destFile, sourceCode, { mode });\n  } else {\n    await Promise.all([\n      writeFile(destFile, sourceCode, { mode }),\n      writeFile(sourceMapPath, sourceMap, { mode }),\n    ]);\n  }\n}\n\nexport async function compile(\n  filename: string,\n  opts: Options,\n  sync: boolean,\n  outputPath: string | undefined\n): Promise<Output | void> {\n  const options = { ...opts };\n  if (outputPath) {\n    options.outputPath = outputPath;\n  }\n\n  try {\n    const result = sync\n      ? transformFileSync(filename, options)\n      : await transformFile(filename, options);\n\n    return result;\n  } catch (err: any) {\n    if (!err.message.includes(\"ignored by .swcrc\")) {\n      throw err;\n    }\n  }\n}\n"],"names":["outputResult","compile","mkdir","stat","writeFile","promises","withSourceMap","output","options","destFile","destDir","map","sourceMaps","sourceCode","code","sourceMap","JSON","parse","sourceFileName","sourceRoot","stringify","sourceMapPath","slash","relative","sourceFile","dirname","recursive","mode","Promise","all","filename","opts","sync","outputPath","result","transformFileSync","transformFile","err","message","includes"],"mappings":"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"}