{"version":3,"sources":["../../src/swc/util.ts"],"sourcesContent":["import * as swc from \"@swc/core\";\nimport slash from \"slash\";\nimport { mkdirSync, writeFileSync, promises } from \"fs\";\nimport { dirname, relative } from \"path\";\n\nexport async function exists(path: string): Promise<boolean> {\n  let pathExists = true;\n  try {\n    await promises.access(path);\n  } catch (err: any) {\n    pathExists = false;\n  }\n  return pathExists;\n}\n\nexport async function transform(\n  filename: string,\n  code: string,\n  opts: swc.Options,\n  sync: boolean,\n  outputPath: string | undefined\n): Promise<swc.Output> {\n  opts = {\n    filename,\n    ...opts,\n  };\n\n  if (outputPath) {\n    opts.outputPath = outputPath;\n  }\n\n  if (sync) {\n    return swc.transformSync(code, opts);\n  }\n\n  return swc.transform(code, opts);\n}\n\nexport async function compile(\n  filename: string,\n  opts: swc.Options,\n  sync: boolean,\n  outputPath: string | undefined\n): Promise<swc.Output | void> {\n  opts = {\n    ...opts,\n  };\n  if (outputPath) {\n    opts.outputPath = outputPath;\n  }\n\n  try {\n    const result = sync\n      ? swc.transformFileSync(filename, opts)\n      : await swc.transformFile(filename, opts);\n\n    if (result.map) {\n      // TODO: fix this in core\n      // https://github.com/swc-project/swc/issues/1388\n      const sourceMap = JSON.parse(result.map);\n      if (opts.sourceFileName) {\n        sourceMap[\"sources\"][0] = opts.sourceFileName;\n      }\n      if (opts.sourceRoot) {\n        sourceMap[\"sourceRoot\"] = opts.sourceRoot;\n      }\n      result.map = JSON.stringify(sourceMap);\n    }\n    return result;\n  } catch (err: any) {\n    if (!err.message.includes(\"ignored by .swcrc\")) {\n      throw err;\n    }\n  }\n}\n\nexport function outputFile(\n  output: swc.Output,\n  filename: string,\n  sourceMaps: undefined | swc.Options[\"sourceMaps\"]\n) {\n  const destDir = dirname(filename);\n  mkdirSync(destDir, { recursive: true });\n\n  let code = output.code;\n  if (output.map && sourceMaps !== \"inline\") {\n    // we've requested for a sourcemap to be written to disk\n    const fileDirName = dirname(filename);\n    const mapLoc = filename + \".map\";\n    code += \"\\n//# sourceMappingURL=\" + slash(relative(fileDirName, mapLoc));\n    writeFileSync(mapLoc, output.map);\n  }\n\n  writeFileSync(filename, code);\n}\n\nexport function assertCompilationResult<T>(\n  result: Map<string, Error | T>,\n  quiet = false\n): asserts result is Map<string, T> {\n  let compiled = 0;\n  let copied = 0;\n  let failed = 0;\n  for (const value of result.values()) {\n    if (value instanceof Error) {\n      failed++;\n    } else if ((value as unknown) === \"copied\") {\n      copied++;\n    } else if (value) {\n      compiled++;\n    }\n  }\n  if (!quiet && compiled + copied > 0) {\n    const copyResult = copied === 0 ? \" \" : ` (copied ${copied}) `;\n    console.info(\n      `Successfully compiled ${compiled} ${\n        compiled !== 1 ? \"files\" : \"file\"\n      }${copyResult}with swc.`\n    );\n  }\n\n  if (failed > 0) {\n    throw new Error(\n      `Failed to compile ${failed} ${failed !== 1 ? \"files\" : \"file\"} with swc.`\n    );\n  }\n}\n"],"names":["exists","transform","compile","outputFile","assertCompilationResult","swc","path","pathExists","promises","access","err","filename","code","opts","sync","outputPath","transformSync","result","transformFileSync","transformFile","map","sourceMap","JSON","parse","sourceFileName","sourceRoot","stringify","message","includes","output","sourceMaps","destDir","dirname","mkdirSync","recursive","fileDirName","mapLoc","slash","relative","writeFileSync","quiet","compiled","copied","failed","value","values","Error","copyResult","console","info"],"mappings":"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"}